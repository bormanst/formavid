#!/bin/bash -e
# Copyright (C) 2018 Sean Borman <bormanst@gmail.com>.
# You should have received LICENSE.txt, a copy of the
# GNU General Public License, along with this program.
# If not, see <https://www.gnu.org/licenses/>.

PACKAGE=gce_instance_startup

echo ""
echo ""
echo "WARNING! Do NOT manually run this script as it here for reference only."
echo "WARNING! This script is only to be used by GCE when starting a new image."
echo "WARNING! Running it manually will corrupt an already initialized appliance."
echo "WARNING! If it is accidentally run, the random password MAY be available"
echo "WARNING! on an index.html page using the ip address of the appliance."
echo ""
echo ""

# check already run
SITES=/var/www/drupal8/prod/web/sites/sites.php
BLOCKING_FILE=/etc/formavid/do_not_delete_this_file
if [ -f ${BLOCKING_FILE} ] || [ -f ${SITES} ]; then exit 0; fi

# export envars
export SINGLE_PASS=`openssl rand -base64 8 | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1`
export SYNC_CSSADMIN="True"

# wipe default passwords with random as security precaution
/usr/local/formavid/bin/initialize/python/change-passwords.py

# disable stunnel4 services
sed -i "s|ENABLED=1|ENABLED=0|" /etc/default/stunnel4
systemctl stop stunnel4

# disable apache2 confs
a2dissite invoiceninja
a2dissite support
a2dissite zzz-admin.examplesitenamecom

WEBROOT=/var/www/html
mkdir -p ${WEBROOT}
WELCOME=${WEBROOT}/index.html
rm -f ${WELCOME}

cat > ${WELCOME} <<EOF
<html><body><h1>Important information regarding initialization of this FormaVid Appliance</h1>
<p>
For security reasons the appliance passwords were randomly seeded by a custom GCE startup script.
Most services have also been disabled to prevent tampering while user generated values are implemented.
This is NOT an optimal solution and requires the user instantiated initialization process to be completed.
Therefore, it is imperative to complete the initialization process as soon as possible.
</p>
<p>
To complete the initialization, a script is provided to automate the process.
The script must be executed as the 'root' system user using an ssh connection.
Information on how to access the instance via ssh can be found at <a href="https://cloud.google.com/compute/docs/instances/connecting-to-instance" alt="Google GCE">Google GCE</a> for convenience.
The password provided below is the one randomly generated by the GCE startup script and should not be used as a user selected password.
</p>
<p>
To finish initialization:<br />
Access appliance with ssh using the <b>admin:${SINGLE_PASS}</b> account (direct ssh root access is blocked).<br />
Then enter "<b>su -</b>" to access the <b>root:${SINGLE_PASS}</b> account to run the script.<br />
Change to the FormaVid scripts directory and run the initialization script: cd /usr/local/formavid/bin && ./initialize_appliance<br />
After the script is finished, the appliance should reboot automatically and everything should be in order.
</p>
<p>
Base Drupal8 site [admin:app_pass] - <b>https://hostname.com</b> <br />
Admin tool pages [admin:tools_pass] - <b>https://admin.hostname.com</b> <br />
Invoice Ninja setup [invoiceninja:invoiceninja_pass] - <b>https://billing.hostname.com</b> <br />
Roundup support tracker [admin:roundup_pass] - <b>https://support.hostname.com/support/</b> <br />
Shell-in-a-box [root:app_pass,admin:app_pass,cssadmin:app_pass] - <b>https://hostname.com:12320</b> <br />
Webmin [root:app_pass] - <b>https://hostname.com:12321</b> <br />
Adminer [admin:app_pass,drupal8:app_pass,invoiceninja:invoiceninja_pass,roundup:roundup_pass] - <b>https://hostname.com:12322</b>
</p>
<p>
Note: To enable SSL, a Certbot script is available in the /usr/local/formavid/applications/certbot directory but it must be manually configured and run.
The easiest option, when prompted, is to use Certbot's built-in apache server plug-in for responding to the confirmation queries.
The Letsencrypt certs allow for subdomains so all of the above domains can be associated to one cert if desired.
See the <a href="https://certbot.eff.org/docs/" alt="Certbot Documentation">Certbot Documentation</a> for further details and options.
Please be aware that there is a limit on the number of requests within a given interval, in case a cert request fails.
</p>
<p>
Please see the <a href="https://github.com/bormanst/formavid/blob/master/INSTALL.txt" alt="INSTALL.txt file">INSTALL.txt file</a> for more information on the appliance structure and how to deploy additional components, if desired.
</p>
<p>
The GCE startup script created a blocking file, /etc/formavid/do_not_delete_this_file, that will prevent the GCE startup script from re-initializing the appliance; this file should NOT be moved or removed.
The user instantiated initialization will enable all of the appliance services, configurations, and will automatically build the initial Drupal8 site.
The process only takes a few minutes and when completed it will remove this page and the corresponding /var/www/html directory.
</p>
<p>
While every effort has been made to make this process as easy and error free as possible, there's always a chance of failure.
If the initialization process fails for some reason, it is recommended to just create a new instance and start from scratch.
The process usually takes less than ten minutes, whereas trying to figure out what went wrong and apply a fix would take considerably longer.
Please report any reasonable issues to FormaVid.org and they will be addressed as required.
Issues like broken internet or ssh pipes (which will absolutely kill the process) are obviously outside the realm of control.
</p>
<p>
It is important to ensure that some form of backup is properly functioning; FormaVid is not responsible for backups and/or loss of data.
Please see sections 15, 16, and 17 of the <a href="https://formavid.org/license" alt="FormaVid Appliance GPL License">FormaVid Appliance GPL License</a> for more information.
</p>
<p>
While the FormaVid appliance provides some scripts to assist, it does NOT automatically configure and enable a preferred backup method.
As this is a GCE instance, <a href="https://cloud.google.com/compute/docs/disks/create-snapshots" alt="GCE snapshots">GCE snapshots</a> can be enabled by running the provided /usr/local/formavid/applications/gcsnapshot/gcsnapshot script.
This is usually free for up to about five 'rolling' snapshots, depending on use case.
For business critical sites, it is additionally recommended to use a more robust backup mechanism that retains archives, such as BorgBackup.
BorgBachup can be enabled and configured using the provided /usr/local/formavid/applications/borgbackup/borgbackup script.
It should be noted, however, that most archiving backup applications will exceed the GCE instance 'egress' limit and will incur a fee to your Google account.
</p>
<p>
More information regarding the appliance can be found at <a href="https://formavid.org/support" alt="FormaVid Support">FormaVid Support</a> and the main site.
Custom support is available at <a href="https://modorbis.com/appliances" alt="Mod Orbis">Mod Orbis</a> if desired or needed.
All code and scripts are hosted on GitHub at <a href="https://github.com/bormanst/formavid" alt="FormaVid Small Business Appliance">FormaVid Small Business Appliance</a> and in the appliance /usr/local/formavid directory.
The default environment variables used to build the appliance are copied to and referenced from the /etc/formavid directory in case the project is re-cloned into the /usr/local/formavid directory.
</p>
<p>
Reminder: this page will be deleted after initialization is completed, so please bookmark any of the desired links on this page for future reference.
</p>
<p>
Thank you for using the FormaVid Small Business Appliance and please remember, if profitable, to <a href="https://formavid.org/download" alt="donate or contribute">donate or contribute</a> to all of the projects used throughout the appliance. The open source community relies on your support.
</p>
</body></html>
EOF

# set perms
chmod 0444 ${WELCOME}
chown www-data:www-data ${WELCOME}

# enable apache2 access
a2ensite 000-default
systemctl restart apache2

# create blocking file
echo "The absence of this file causes the GCE start-up script to reset passwords to a random one, which may result in a 'lock-out' condition." > ${BLOCKING_FILE}
chmod 0444 ${BLOCKING_FILE}

exit 0
