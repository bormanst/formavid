#!/bin/bash
# Copyright (C) 2018 Sean Borman <bormanst@gmail.com>.
# You should have received LICENSE.txt, a copy of the
# GNU General Public License, along with this program.
# If not, see <https://www.gnu.org/licenses/>.

# regenerate simpleinvoices secrets and mysql password

ENCRYPT_KEY=`head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32 ; echo ''`
NONCE_KEY=`head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32 ; echo ''`

CONF=/var/www/simpleinvoices/config/config.php
sed -i "s|^encryption.default.key.*|encryption.default.key = ${ENCRYPT_KEY}|" ${CONF}
sed -i "s|^nonce.key.*|nonce.key = ${NONCE_KEY}|" ${CONF}

PASSWORD=`head /dev/urandom | tr -dc A-Za-z0-9 | head -c 13 ; echo ''`
sed -i "0,/params.password/s/params.password.*/params.password = ${PASSWORD}/" ${CONF}
${FORMAVID}/bin/initialize/python/mysqlconf.py --user=simpleinvoices --pass="${PASSWORD}"

# Delete APACHE_PASSWD if exists.
APACHE_PASSWD=/usr/local/apache2/passwd/simpleinvoices
if [ -d ${APACHE_PASSWD} ]; then
    rm -rf ${APACHE_PASSWD}
fi
