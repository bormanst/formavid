#!/bin/bash -e
# Copyright (C) 2018 Sean Borman <bormanst@gmail.com>.
# You should have received LICENSE.txt, a copy of the
# GNU General Public License, along with this program.
# If not, see <https://www.gnu.org/licenses/>.

PACKAGE=initialize_appliance

# set default FORMAVID
export FORMAVID=/usr/local/formavid

# check FORMAVID
if [ ! -d "${FORMAVID}" ]; then
    # dir should exist: this script is supposed to be located in formavid/bin
    export FORMAVID=$(find /usr/local -name "formavid")
    if [ -z "${FORMAVID}" ]; then
        echo ""
        echo ""
        echo "WARNING! ${PACKAGE} depends on formavid's location being in /usr/local."
        echo "WARNING! Please ensure that formavid is located in /usr/local."
        echo "WARNING! OR"
        echo "WARNING! Modify formavid's default location formavid/bin/${PACKAGE}."
        echo ""
        echo ""
        exit 0
    fi
fi

# set bin dir
BIN_DIR=${FORMAVID}/bin

# check envars
if [ -z "${APP_EMAIL}" ]; then
    # set passwords only
    export PASSWORDS_ONLY="True";
    ${BIN_DIR}/deploy/python/get-envars.py;
fi

# run sub-scripts
SCRIPT_DIR=${BIN_DIR}/initialize/shell

# check script dir
if [ ! -d "${SCRIPT_DIR}" ]; then exit 0; fi

# loop through scripts
for SCRIPT in $(find ${SCRIPT_DIR} -type f -or -type l | sort); do
    # check executable
    [ -x "${SCRIPT}" ] || continue
    # execute script
    echo "# ${SCRIPT}"
    ${SCRIPT}
done

exit 0
